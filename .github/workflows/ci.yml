name: CI/CD Pipeline

on: [push]

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    outputs:
      app_version: ${{ steps.version_step.outputs.version }}

    steps:
    - id: version_step
      run: echo "version=1.2.3" >> $GITHUB_OUTPUT
      
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Install dependencies
      id: build-step
      run: npm install

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Print version
      run: echo "Deploying version ${{ needs.build.outputs.app_version }}"
      
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Start server in background
      run: |
        node server.js &
        sleep 3

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: deploy

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Run health check test
      run: |
        chmod +x test.sh
        ./test.sh

    - name: Stop server
      run: |
        pkill -f "node server.js" || true
